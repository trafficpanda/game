from dataclasses import dataclass
from typing import Dict, List, Optional

from .db import is_step_completed


@dataclass
class CourseStep:
    id: str
    module_id: str   # например day1, day2, exam
    title: str
    content: str
    question: str
    options: List[str]
    correct_index: int
    reward_xp: int
    reward_coins: int


COURSE_STEPS: Dict[str, CourseStep] = {}


def init_course_data():
    """
    7 дней обучения + экзамен.
    В каждом дне 3 шага (уроки+микро-тесты).
    В конце — 5 экзаменационных вопросов с повышенной наградой.
    """
    steps: List[CourseStep] = [
        # ===== День 1: Основы арбитража и экономики =====
        CourseStep(
            id="d1_s1",
            module_id="day1",
            title="Что такое арбитраж трафика",
            content=(
                "Арбитраж трафика — это когда ты покупаешь трафик (клики, показы) "
                "по одной цене и приводишь его на оффер, за что получаешь оплату по модели CPA/CPL/CPS.\n\n"
                "Твоя задача — сделать так, чтобы доход с оффера был больше расходов на рекламу. "
                "Разница между доходом и расходами — твоя прибыль."
            ),
            question="Что является источником прибыли арбитражника?",
            options=[
                "Зарплата от партнёрской сети",
                "Разница между доходом с оффера и расходами на трафик",
                "Продажа физических товаров в офлайне",
            ],
            correct_index=1,
            reward_xp=50,
            reward_coins=5_000,
        ),
        CourseStep(
            id="d1_s2",
            module_id="day1",
            title="Участники рынка",
            content=(
                "В арбитраже есть несколько ключевых ролей:\n"
                "• Рекламодатель — владелец продукта или услуги.\n"
                "• Партнёрская сеть (CPA-сеть) — посредник, который даёт вебмастерам офферы.\n"
                "• Арбитражник (вебмастер) — покупает трафик и льёт его на офферы.\n\n"
                "Арбитражник работает по офферам CPA-сети и получает оплату за целевые действия."
            ),
            question="Кто такой арбитражник?",
            options=[
                "Человек, который создаёт товар",
                "Партнёрская сеть, которая платит вебмастерам",
                "Вебмастер, который покупает трафик и льёт его на офферы",
            ],
            correct_index=2,
            reward_xp=50,
            reward_coins=5_000,
        ),
        CourseStep(
            id="d1_s3",
            module_id="day1",
            title="Базовая экономика: CTR, CR, ROI",
            content=(
                "Основные метрики:\n"
                "• CTR — кликабельность (сколько людей кликнули по объявлению).\n"
                "• CR — конверсия (какой процент людей сделал целевое действие).\n"
                "• ROI — возврат инвестиций: (Доход - Расход) / Расход * 100%.\n\n"
                "Положительный ROI (>0%) означает, что связка зарабатывает деньги."
            ),
            question="Что показывает ROI в арбитраже?",
            options=[
                "Процент людей, которые кликнули по объявлению",
                "Процент окупаемости вложений в рекламу",
                "Количество показов за день",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),

        # ===== День 2: Партнёрки и офферы =====
        CourseStep(
            id="d2_s1",
            module_id="day2",
            title="Выбор партнёрской сети",
            content=(
                "При выборе CPA-сети смотри на:\n"
                "• Репутацию и отзывы.\n"
                "• Условия выплат (минималка, холд, способы вывода).\n"
                "• Наличие саппорта и менеджера.\n"
                "• Количество и качество офферов.\n\n"
                "Хорошая сетка — это основа стабильной работы."
            ),
            question="Что из этого важнее всего при выборе партнёрской сети?",
            options=[
                "Только красивый сайт",
                "Репутация, выплаты и поддержка",
                "Наличие мобильного приложения",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),
        CourseStep(
            id="d2_s2",
            module_id="day2",
            title="Как читать карточку оффера",
            content=(
                "В карточке оффера важно:\n"
                "• GEO — страна, куда льётся трафик.\n"
                "• Payout — выплата за целевое действие.\n"
                "• CR/Approve — как часто лиды принимаются.\n"
                "• Caps — лимит по объёму трафика.\n"
                "• Restrictions — ограничения по источникам и креативам.\n\n"
                "Нельзя игнорировать ограничения: за нарушения могут не оплатить трафик."
            ),
            question="Что означают Restrictions в оффере?",
            options=[
                "Размер выплаты за лид",
                "Разрешённые и запрещённые креативы/источники трафика",
                "Количество лидов в день",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),
        CourseStep(
            id="d2_s3",
            module_id="day2",
            title="Вертикали: Nutra, Gambling, Finance и другие",
            content=(
                "Вертикаль — это тематика оффера.\n"
                "Популярные вертикали:\n"
                "• Nutra — товары для здоровья и красоты.\n"
                "• Gambling/Betting — казино и ставки.\n"
                "• Finance — кредиты, карты, инвестиции.\n"
                "• Dating — знакомства.\n\n"
                "Каждая вертикаль имеет свои особенности по модерации, выплатам и рискам."
            ),
            question="Что такое вертикаль в арбитраже?",
            options=[
                "Сумма выплаты по офферу",
                "Тематика группы в Telegram",
                "Тематика офферов (здоровье, азартные игры, финансы и т.д.)",
            ],
            correct_index=2,
            reward_xp=60,
            reward_coins=6_000,
        ),

        # ===== День 3: Источники трафика =====
        CourseStep(
            id="d3_s1",
            module_id="day3",
            title="Основные источники трафика",
            content=(
                "Есть множество источников трафика:\n"
                "• Facebook/Meta — мощная платформа, но строгая модерация.\n"
                "• TikTok — быстрый трафик, хорошо для креативных связок.\n"
                "• Google Ads/UAC — поисковый и контекстный трафик.\n"
                "• Тизерные сети, push-уведомления, баннерные сети.\n"
                "• Telegram — каналы, боты, рекламные посты.\n\n"
                "На старте проще фокусироваться на 1–2 источниках, а не пытаться хватать всё сразу."
            ),
            question="Почему не стоит сразу брать много источников трафика?",
            options=[
                "Потому что запрещено правилами сетей",
                "Сложно эффективно тестировать и анализировать, лучше сфокусироваться",
                "Потому что нельзя запускать более одной кампании",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),
        CourseStep(
            id="d3_s2",
            module_id="day3",
            title="Белая, серая и чёрная работа",
            content=(
                "Условно выделяют:\n"
                "• Белые подходы — полностью соответствуют правилам площадки и закону.\n"
                "• Серые — на грани правил (кликбейт, агрессивный маркетинг, но без откровенного обмана).\n"
                "• Чёрные — с обманом пользователя, нарушением законов и правил.\n\n"
                "Мы уделяем внимание только белым и максимально безопасным подходам. "
                "Чёрные схемы могут дать быстрый доход, но приводят к банам и рискам."
            ),
            question="Почему опасно использовать чёрные схемы?",
            options=[
                "Они не дают трафика",
                "Можно потерять аккаунты, деньги и попасть на серьёзные риски",
                "Они ничего не продают",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),
        CourseStep(
            id="d3_s3",
            module_id="day3",
            title="Модерация и баны",
            content=(
                "Рекламные платформы модерируют объявления:\n"
                "• Проверяют соответствие правилам.\n"
                "• Блокируют объявления и аккаунты за нарушения.\n\n"
                "Чтобы снизить риск банов:\n"
                "• Не используй запрещённые темы и обещания.\n"
                "• Не вводи пользователя в заблуждение.\n"
                "• Следи за актуальными правилами площадки."
            ),
            question="Что помогает снизить риск бана рекламного аккаунта?",
            options=[
                "Игнорировать правила и запускать как есть",
                "Следить за правилами площадки и не использовать запрещённый контент",
                "Постоянно повышать ставку за клик",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),

        # ===== День 4: Креативы и воронка =====
        CourseStep(
            id="d4_s1",
            module_id="day4",
            title="Структура креатива",
            content=(
                "Креатив обычно состоит из:\n"
                "• Зацепа — привлекает внимание.\n"
                "• Боли/желания — показывает проблему или мечту пользователя.\n"
                "• Решения — продукт/оффер как ответ.\n"
                "• Призыва к действию (CTA) — что сделать сейчас.\n\n"
                "Хороший креатив понятен без лишних объяснений и не обманывает ожидания пользователя."
            ),
            question="Что такое CTA (Call To Action) в креативе?",
            options=[
                "Скрытый текст для модерации",
                "Призыв к действию (зарегистрироваться, оставить заявку и т.д.)",
                "Описание продукта",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),
        CourseStep(
            id="d4_s2",
            module_id="day4",
            title="Воронка: путь пользователя",
            content=(
                "Классическая воронка:\n"
                "Креатив → Ленд/преленд → Форма/регистрация → Дозвон/оплата.\n\n"
                "Каждый шаг может 'просаживать' конверсию:\n"
                "• Слабый креатив — мало кликов.\n"
                "• Непонятный лендинг — мало заявок.\n"
                "• Плохой колл-центр — мало подтверждений.\n\n"
                "Важно смотреть на всю цепочку, а не только на креатив или оффер."
            ),
            question="Что такое воронка в арбитраже?",
            options=[
                "Список всех офферов в сетке",
                "Путь пользователя от клика до целевого действия",
                "Только страница лендинга",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),
        CourseStep(
            id="d4_s3",
            module_id="day4",
            title="A/B-тесты",
            content=(
                "A/B-тест — это сравнение двух вариантов (A и B), отличающихся чем-то одним:\n"
                "• Текстом креатива.\n"
                "• Картинкой.\n"
                "• Заголовком.\n\n"
                "Важно:\n"
                "• Менять по одному параметру за раз.\n"
                "• Собрать достаточно данных, прежде чем делать выводы."
            ),
            question="Как правильно проводить A/B-тест?",
            options=[
                "Менять всё сразу: текст, картинку, оффер",
                "Менять по одному параметру и анализировать разницу",
                "Не смотреть на статистику, ориентироваться только на интуицию",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),

        # ===== День 5: Аналитика и оптимизация =====
        CourseStep(
            id="d5_s1",
            module_id="day5",
            title="Трекинг и UTM-метки",
            content=(
                "Трекинг — это система, которая позволяет видеть, откуда пришёл лид.\n"
                "UTM-метки — параметры в ссылке (utm_source, utm_campaign и т.д.),\n"
                "которые помогают понять, какая кампания и объявление принесли результат.\n\n"
                "Даже простой трекинг сильно повышает качество оптимизации."
            ),
            question="Зачем нужны UTM-метки?",
            options=[
                "Чтобы уменьшить стоимость клика",
                "Чтобы отслеживать, из какой кампании и объявления пришёл лид",
                "Чтобы ускорить модерацию",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),
        CourseStep(
            id="d5_s2",
            module_id="day5",
            title="Когда резать кампанию, а когда масштабировать",
            content=(
                "Если кампания стабильно уходит в минус (ROI < 0) и тестовый бюджет выбран, "
                "её имеет смысл остановить.\n\n"
                "Если кампания стабильно в плюс и показывает хороший ROI, её можно масштабировать:\n"
                "• Повышать бюджет.\n"
                "• Расширять аудитории.\n"
                "• Запускать похожие связки."
            ),
            question="Что делать с кампанией, которая стабильно в плюс по ROI?",
            options=[
                "Остановить её",
                "Игнорировать и не менять",
                "Масштабировать (увеличивать бюджет, дублировать связки)",
            ],
            correct_index=2,
            reward_xp=60,
            reward_coins=6_000,
        ),
        CourseStep(
            id="d5_s3",
            module_id="day5",
            title="Работа с тестовым бюджетом",
            content=(
                "Перед запуском желательно определить тестовый бюджет.\n"
                "Например: 3–5 выплат по офферу.\n\n"
                "Если после открутки тестового бюджета нет намёка на плюс — связку можно признать неудачной."
            ),
            question="Что такое тестовый бюджет?",
            options=[
                "Случайная сумма, которую ты тратишь без анализа",
                "Предварительно определённая сумма для проверки связки",
                "Минимальный депозит в партнёрской сети",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),

        # ===== День 6: Стратегия и безопасность =====
        CourseStep(
            id="d6_s1",
            module_id="day6",
            title="Выбор вертикали и источника",
            content=(
                "На старте лучше:\n"
                "• Выбрать 1 безопасную вертикаль (например, Nutra или белый e-commerce).\n"
                "• Выбрать 1–2 источника трафика.\n\n"
                "Слишком широкий фокус приводит к хаосу и сложностям с анализом."
            ),
            question="Как лучше действовать новичку при выборе вертикали и источника?",
            options=[
                "Пробовать всё подряд без анализа",
                "Сфокусироваться на 1 вертикали и 1–2 источниках",
                "Вообще не выбирать, пусть решит партнёрская сеть",
            ],
            correct_index=1,
            reward_xp=60,
            reward_coins=6_000,
        ),
        CourseStep(
            id="d6_s2",
            module_id="day6",
            title="Безопасность и юридические риски",
            content=(
                "Важно избегать:\n"
                "• Явного обмана пользователей.\n"
                "• Нарушения законов страны, где льёшь трафик.\n"
                "• Работы с откровенно мошенническими офферами.\n\n"
                "По юридическим вопросам лучше консультироваться с профильными специалистами."
            ),
            question="Что из этого безопаснее всего для долгосрочной работы?",
            options=[
                "Работать с офферами, которые явно нарушают законы",
                "Работать с белыми офферами и избегать обмана",
                "Игнорировать законы и правила",
            ],
            correct_index=1,
            reward_xp=70,
            reward_coins=7_000,
        ),
        CourseStep(
            id="d6_s3",
            module_id="day6",
            title="План на 30 дней",
            content=(
                "Примерный план на первый месяц:\n"
                "• День 1–7 — обучение и тестовые запуски маленьких бюджетов.\n"
                "• День 8–15 — поиск 1–2 рабочих связок.\n"
                "• День 16–30 — масштабирование удачных связок и оптимизация.\n\n"
                "Главное — не сдаваться после первых неудач. Большинство связок не выстреливает."
            ),
            question="Что главное в первых 30 днях работы?",
            options=[
                "Найти одну волшебную схему и больше ничего не делать",
                "Жёстко масштабироваться с первого дня",
                "Обучаться, тестировать и постепенно масштабировать успешные связки",
            ],
            correct_index=2,
            reward_xp=60,
            reward_coins=6_000,
        ),

        # ===== День 7: Подготовка к экзамену =====
        CourseStep(
            id="d7_s1",
            module_id="day7",
            title="Повторение ключевых терминов",
            content=(
                "Перед экзаменом важно повторить:\n"
                "• Что такое CPA, CPL, CPS, RevShare.\n"
                "• Что такое CTR, CR, ROI.\n"
                "• Как читать карточку оффера.\n"
                "• В чём разница между вертикалями.\n\n"
                "Экзамен закрепит понимание, а награда будет повышенной."
            ),
            question="Что из этого относится к метрикам эффективности?",
            options=[
                "CTR, CR, ROI",
                "GEO, Payout",
                "Caps, Restrictions",
            ],
            correct_index=0,
            reward_xp=80,
            reward_coins=8_000,
        ),
        CourseStep(
            id="d7_s2",
            module_id="day7",
            title="Ошибки новичков",
            content=(
                "Частые ошибки:\n"
                "• Слишком быстрый слив бюджета без анализа.\n"
                "• Игнорирование статистики и метрик.\n"
                "• Погоня за 'секретной схемой' вместо системной работы.\n\n"
                "Твоя сила — в системности и регулярном обучении."
            ),
            question="Какая стратегия выглядит наиболее здравой?",
            options=[
                "Искать одну “секретную схему” и копировать её бесконечно",
                "Системно обучаться, тестировать и анализировать результаты",
                "Не смотреть на метрики, ориентироваться только на удачу",
            ],
            correct_index=1,
            reward_xp=80,
            reward_coins=8_000,
        ),
        CourseStep(
            id="d7_s3",
            module_id="day7",
            title="Мышление арбитражника",
            content=(
                "Успешный арбитражник:\n"
                "• Думает в цифрах и гипотезах.\n"
                "• Не боится тестировать и ошибаться.\n"
                "• Строит систему, а не гонится за разовыми кейсами.\n\n"
                "Экзамен — это не конец, а только старт следующего уровня."
            ),
            question="Что важнее всего для арбитражника?",
            options=[
                "Слепо копировать чужие креативы",
                "Уметь думать в цифрах, тестировать и анализировать",
                "Ждать идеального момента и ничего не запускать",
            ],
            correct_index=1,
            reward_xp=80,
            reward_coins=8_000,
        ),

        # ===== Экзамен: 5 вопросов с повышенной наградой =====
        CourseStep(
            id="ex_s1",
            module_id="exam",
            title="Экзамен (1/5): экономика",
            content=(
                "Экзамен. Вопрос 1 из 5.\n\n"
                "Ты потратил 100$ на рекламу и получил 150$ выплат.\n"
                "Какой примерный ROI?"
            ),
            question="Примерный ROI в этом примере:",
            options=[
                "+50%",
                "+150%",
                "-50%",
            ],
            correct_index=0,
            reward_xp=120,
            reward_coins=20_000,
        ),
        CourseStep(
            id="ex_s2",
            module_id="exam",
            title="Экзамен (2/5): офферы",
            content=(
                "Экзамен. Вопрос 2 из 5.\n\n"
                "В карточке оффера ты видишь высокий Payout, но маленький CR и строгие Restrictions."
            ),
            question="О чём это может говорить?",
            options=[
                "Оффер лёгкий, и его можно лить как угодно",
                "Оффер сложный, конверсия низкая, есть жёсткие ограничения — нужно быть осторожным",
                "Оффер не будет ничего платить",
            ],
            correct_index=1,
            reward_xp=120,
            reward_coins=20_000,
        ),
        CourseStep(
            id="ex_s3",
            module_id="exam",
            title="Экзамен (3/5): источники трафика",
            content=(
                "Экзамен. Вопрос 3 из 5.\n\n"
                "Ты решил начать с одной вертикали и одного источника трафика."
            ),
            question="Почему это разумное решение?",
            options=[
                "Так проще сосредоточиться и анализировать результаты",
                "Потому что запрещено использовать больше одного источника",
                "Потому что партнёрка платит только за один источник",
            ],
            correct_index=0,
            reward_xp=120,
            reward_coins=20_000,
        ),
        CourseStep(
            id="ex_s4",
            module_id="exam",
            title="Экзамен (4/5): креативы",
            content=(
                "Экзамен. Вопрос 4 из 5.\n\n"
                "У тебя есть два варианта креатива: A и B.\n"
                "Ты хочешь понять, какой работает лучше."
            ),
            question="Как правильно провести тест?",
            options=[
                "Менять в каждом креативе всё сразу и смотреть на общую статистику",
                "Менять по одному параметру (например, картинку) и сравнивать результаты",
                "Не смотреть на статистику вообще",
            ],
            correct_index=1,
            reward_xp=120,
            reward_coins=20_000,
        ),
        CourseStep(
            id="ex_s5",
            module_id="exam",
            title="Экзамен (5/5): стратегия",
            content=(
                "Экзамен. Вопрос 5 из 5.\n\n"
                "Ты прошёл обучение, протестировал несколько связок и нашёл одну рабочую."
            ),
            question="Что логичнее всего делать дальше?",
            options=[
                "Бросить эту связку и искать новую",
                "Масштабировать рабочую связку и параллельно тестировать новые",
                "Вообще перестать запускать рекламу",
            ],
            correct_index=1,
            reward_xp=200,
            reward_coins=40_000,
        ),
    ]

    COURSE_STEPS.clear()
    for s in steps:
        COURSE_STEPS[s.id] = s


async def get_next_step_for_user(user_id: int) -> Optional[CourseStep]:
    for step in COURSE_STEPS.values():
        if not await is_step_completed(user_id, step.id):
            return step
    return None
